<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart Solar Water Purification System - Getrude Chizana, HIT 2025</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<style>
  :root {
    --primary-color: #0069d9;
    --secondary-color: #0056b3;
    --accent-color: #0dcaf0;
    --bg-light: #f8f9fa;
    --text-dark: #212529;
  }
  body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--bg-light);
    margin: 0;
    min-height: 100vh;
  }
  /* Layout */
  #app {
    display: flex;
    min-height: 100vh;
    overflow-x: hidden;
  }
  /* Sidebar */
  aside.sidebar {
    background-color: var(--primary-color);
    color: white;
    width: 260px;
    min-height: 100vh;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease;
    z-index: 1045;
    user-select: none;
  }
  aside.sidebar.hidden {
    display: none !important;
  }
  aside.sidebar .sidebar-header {
    padding: 1.5rem;
    font-weight: 700;
    font-size: 1.25rem;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.2);
  }
  aside.sidebar nav.nav-link {
    color: white;
    font-weight: 500;
    padding: 0.85rem 1.5rem;
    border-left: 4px solid transparent;
    transition: background-color 0.3s, border-color 0.3s;
  }
  aside.sidebar nav.nav-link:hover,
  aside.sidebar nav.nav-link.active {
    background-color: rgba(255,255,255,0.15);
    border-left-color: #0dcaf0;
    color: #0dcaf0;
  }
  /* Sidebar toggle button for small screens */
  #sidebarToggleBtn {
    display: none;
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 1100;
    background-color: var(--primary-color);
    border: none;
    border-radius: 0.25rem;
    width: 44px;
    height: 44px;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  /* Content */
  main.content {
    flex-grow: 1;
    padding: 1.25rem 2rem;
    min-height: 100vh;
    background-color: white;
    overflow-y: auto;
  }
  /* Responsive */
  @media (max-width: 992px) {
    aside.sidebar {
      position: fixed;
      top: 0; left: 0;
      height: 100vh;
      transform: translateX(-100%);
      box-shadow: 4px 0 12px rgba(0,0,0,0.1);
    }
    aside.sidebar.open {
      transform: translateX(0);
    }
    #sidebarToggleBtn {
      display: block;
    }
    main.content {
      padding-top: 4rem;
    }
  }
  /* Hero Section */
  #welcomeHero {
    min-height: 45vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    background:
      linear-gradient(135deg, rgba(0,105,217,0.75), rgba(13,202,240,0.75)),
      url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1470&q=80') no-repeat center center/cover;
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    user-select: none;
  }
  #welcomeHero h1 {
    font-size: 3.25rem;
    font-weight: 700;
    text-shadow: 0 3px 8px rgba(0,0,0,0.6);
    margin-bottom: 0.8rem;
  }
  #welcomeHero p {
    max-width: 720px;
    font-size: 1.3rem;
    font-weight: 400;
    margin-bottom: 2rem;
    text-shadow: 0 2px 6px rgba(0,0,0,0.5);
  }
  #welcomeHero button {
    font-size: 1.15rem;
    padding: 0.65rem 2rem;
    border-radius: 50px;
    font-weight: 600;
    user-select: none;
  }
  #welcomeHero button:hover {
    background-color: var(--secondary-color);
    border-color: var(--secondary-color);
  }

  /* Wide section containers for welcome sections */
  .welcome-section {
    max-width: 900px;
    margin: 2rem auto;
    padding: 1rem 1.5rem;
  }
  .welcome-section h2 {
    font-weight: 600;
    margin-bottom: 0.75rem;
    border-bottom: 3px solid var(--accent-color);
    padding-bottom: 0.25rem;
  }
  .welcome-section p, .welcome-section ul {
    font-size: 1rem;
    line-height: 1.5;
    color: var(--text-dark);
  }
  .welcome-section ul {
    padding-left: 1.2rem;
  }
  .welcome-section li {
    margin-bottom: 0.3rem;
  }

  /* Dashboard initial hero */
  #dashboardHero {
    background-color: #e9f7ff;
    border-left: 5px solid var(--accent-color);
    padding: 1.2rem 1.5rem;
    margin-bottom: 2rem;
    border-radius: 8px;
    color: #055160;
    font-weight: 500;
  }

  /* Dashboard Stats Cards */
  .stat-card {
    transition: transform 0.25s ease, box-shadow 0.25s ease;
  }
  .stat-card:hover {
    transform: scale(1.03);
    box-shadow: 0 0 24px rgba(13,202,240,0.35);
  }

  /* Table */
  table#unitsTable > tbody > tr:hover {
    background-color: #e0f7fa;
  }

  /* Footer */
  footer.footer {
    padding: 1rem 0;
    text-align: center;
    font-size: 0.875rem;
    color: #666;
    border-top: 1px solid #ddd;
    margin-top: 4rem;
  }

  /* Accessible focus outline */
  a:focus,
  button:focus,
  input:focus,
  select:focus,
  textarea:focus {
    outline: 3px solid var(--accent-color);
    outline-offset: 2px;
  }
</style>
</head>
<body>
<button id="sidebarToggleBtn" aria-label="Toggle sidebar menu" aria-expanded="false" aria-controls="sidebar" aria-haspopup="true" aria-pressed="false">
  <i class="bi bi-list"></i>
</button>

<div id="app" class="d-flex">
  <aside id="sidebar" class="sidebar hidden" role="complementary" aria-label="Main navigation sidebar" tabindex="-1">
    <div class="sidebar-header" tabindex="0">
      <i class="bi bi-droplet-half me-2"></i>
      <span>Smart Solar Water Purification</span><br />
      <small style="font-weight:300; font-size:.825rem;">By Getrude Chizana, HIT 2025</small>
    </div>
    <nav class="nav flex-column mt-3" aria-label="Sidebar navigation">
      <a href="#" class="nav-link active" data-section="welcome" tabindex="0"><i class="bi bi-house-door-fill me-2"></i>Welcome</a>
      <a href="#" class="nav-link" data-section="introduction"><i class="bi bi-book-half me-2"></i>Introduction</a>
      <a href="#" class="nav-link" data-section="objectives"><i class="bi bi-bullseye me-2"></i>Objectives</a>
      <a href="#" class="nav-link" data-section="functionality"><i class="bi bi-gear-fill me-2"></i>Functionality</a>
      <a href="#" class="nav-link" data-section="requirements"><i class="bi bi-list-check me-2"></i>Requirements</a>
      <a href="#" class="nav-link" data-section="dashboard"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
      <a href="#" class="nav-link" data-section="crud"><i class="bi bi-pencil-square me-2"></i>Manage Units</a>
      <a href="#" class="nav-link" id="logoutNav"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
    </nav>
  </aside>

  <main class="content" tabindex="0" aria-live="polite">

    <!-- Welcome Page -->
    <section id="welcome" role="region" aria-label="Welcome Page">
      <div id="welcomeHero">
        <h1>Smart Solar Water Purification System</h1>
        <p>
          Utilizing solar energy and IoT technologies to provide sustainable, reliable, and safe water purification for rural communities.
        </p>
        <button class="btn btn-light btn-lg" id="btnGoLogin" aria-haspopup="dialog" aria-controls="loginModal" aria-label="Open login form">
          <i class="bi bi-box-arrow-in-right"></i> Login
        </button>
      </div>

      <div class="welcome-section" id="welcome-what">
        <h2>About This System</h2>
        <p>
          This system harnesses renewable solar power combined with advanced filtration and real-time digital control to address water scarcity, contamination, and health issues in rural areas.
        </p>
      </div>

      <div class="welcome-section" id="welcome-objectives">
        <h2>Main Objectives</h2>
        <ul>
          <li>Design a solar-powered water purification plant controlled digitally.</li>
          <li>Enable real-time monitoring and automated operation via smartphone integration.</li>
          <li>Empower Zimbabwean rural communities with portable, sustainable water purification technology.</li>
          <li>Reduce waterborne diseases by providing safe and affordable drinking water.</li>
        </ul>
      </div>

      <div class="welcome-section" id="welcome-who">
        <h2>Project By</h2>
        <p><strong>Getrude Chizana</strong></p>
        <p>Harare Institute Of Technology &mdash; Diploma in Integrated Telecommunication Engineering, June 2025</p>
      </div>
    </section>

    <!-- Introduction Page -->
    <section id="introduction" class="d-none" role="region" aria-label="Project Introduction">
      <h2>Chapter 1: Introduction</h2>
      <p><strong>1.1 Introduction</strong><br />
      Access to clean water remains a critical challenge in many rural communities. The Smart Solar Energy Based Water Purification System is designed to address this by using renewable solar energy and digital technologies to provide safe and affordable water for household use, reducing waterborne diseases and empowering communities.</p>
      <p><strong>1.2 Background</strong><br />
      Water purification has evolved from ancient methods to modern solar-powered systems with digital integration such as IoT and smartphone monitoring, increasing adoption in rural areas.</p>
      <p><strong>1.3 Problem Statement</strong><br />
      Water scarcity and contamination cause disease and mortality in rural areas. There's a need for smart solar powered tools providing sustainable and real-time water purification solutions.</p>
      <p><strong>1.4 Significance of the Project</strong><br />
      Benefits include health impact, economic savings, environmental sustainability, policymaking support, and community empowerment.</p>
    </section>

    <!-- Objectives Page -->
    <section id="objectives" class="d-none" role="region" aria-label="Project Objectives">
      <h2>1.6 Objectives</h2>
      <ul>
        <li>Design a water purification plant powered by solar energy and controlled digitally.</li>
        <li>Program a system capable of executing user commands for water purification.</li>
        <li>Develop a portable smart solar purification system for use in Zimbabwean communities.</li>
        <li>Innovate by integrating smartphone technology for monitoring and regulation.</li>
      </ul>
    </section>

    <!-- Functionality Page -->
    <section id="functionality" class="d-none" role="region" aria-label="Project Functionality">
      <h2>1.7 Functionality</h2>
      <p>The smart solar water purification system operates through the following components:</p>
      <table class="table table-bordered">
        <thead><tr><th>Component</th><th>Function</th></tr></thead>
        <tbody>
          <tr><td>Solar Panels</td><td>Capture solar energy and convert it to electrical power.</td></tr>
          <tr><td>Charge Controller</td><td>Regulates battery charging, preventing overcharging.</td></tr>
          <tr><td>Battery</td><td>Stores electrical energy for use during low sunlight or at night.</td></tr>
          <tr><td>Electromagnetic Relay</td><td>Connects/disconnects the battery to the purification unit as needed.</td></tr>
          <tr><td>Voltage Regulator</td><td>Converts 24V from the battery to 5V required by the microcontroller.</td></tr>
          <tr><td>Microcontroller</td><td>Monitors and controls the purification process, including water levels and system status.</td></tr>
          <tr><td>High Pressure Motor</td><td>Generates pressure needed for reverse osmosis.</td></tr>
          <tr><td>Reverse Osmosis Unit</td><td>Removes contaminants and purifies water.</td></tr>
          <tr><td>Water Tank</td><td>Stores purified water for household use.</td></tr>
        </tbody>
      </table>
      <ul>
        <li>Real-time monitoring and control via smartphone app.</li>
        <li>Automatic prevention of water overflow.</li>
        <li>Reliable operation even in areas without grid electricity.</li>
      </ul>
    </section>

    <!-- Requirements Page -->
    <section id="requirements" class="d-none" role="region" aria-label="Project Requirements">
      <h2>Chapter 2: Requirements Engineering</h2>
      <p>The system provides a sustainable off-grid solution for water purification using solar energy and smartphone enabled regulation, overcoming challenges in rural areas.</p>
      <p><strong>Literature Review highlights:</strong> Solar powered water purification offers sustainability, adaptability, and cost-effectiveness. Studies emphasize community integration and innovations such as photovoltaic filtration.</p>
      <p><strong>Business Value:</strong></p>
      <ul>
        <li>Reduces costs by ~40%</li>
        <li>Increases water production by 25%</li>
        <li>Ensures consistent water quality with real-time monitoring</li>
        <li>Enables remote management via smartphone apps</li>
      </ul>
      <p><strong>Information Gathering:</strong> Includes surveys, interviews, and project evaluations focusing on sustainability and adoption barriers.</p>
      <p><strong>Benefits:</strong></p>
      <ul>
        <li>Tangible: cost savings, health improvements, environmental impact</li>
        <li>Intangible: improved quality of life, community empowerment</li>
      </ul>
      <p><strong>Feasibility:</strong> Technically and economically feasible with proper training and resources.</p>
    </section>

    <!-- Dashboard Page -->
    <section id="dashboard" class="d-none" role="region" aria-label="Dashboard Overview">
      <div id="dashboardHero" tabindex="0">
        <p>
          <strong>Welcome to your Dashboard.</strong><br />
          Use the menu icon or sidebar to navigate and start managing the system.
        </p>
      </div>

      <h2 class="mb-4 visually-hidden">Dashboard Overview</h2>

      <div class="row g-4 mb-3">
        <div class="col-md-4">
          <div class="card p-3 stat-card bg-light border-info" tabindex="0" aria-label="Solar Panels Active count">
            <div class="d-flex align-items-center text-info">
              <i class="bi bi-sunset-fill display-4 me-3" aria-hidden="true"></i>
              <div>
                <h5>Solar Panels Active</h5>
                <p class="fs-3 fw-bold" id="solarActiveCount">0</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 stat-card bg-light border-success" tabindex="0" aria-label="Purified Water Liters count">
            <div class="d-flex align-items-center text-success">
              <i class="bi bi-tint-fill display-4 me-3" aria-hidden="true"></i>
              <div>
                <h5>Purified Water Liters</h5>
                <p class="fs-3 fw-bold" id="waterLitersCount">0</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 stat-card bg-light border-warning" tabindex="0" aria-label="System Alerts count">
            <div class="d-flex align-items-center text-warning">
              <i class="bi bi-graph-up-arrow display-4 me-3" aria-hidden="true"></i>
              <div>
                <h5>System Alerts</h5>
                <p class="fs-3 fw-bold" id="alertsCount">0</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <h3 class="mb-3">Visual Reports</h3>
      <div class="row g-4">
        <div class="col-lg-4 col-md-6">
          <div class="card p-3 shadow-sm">
            <h5><i class="bi bi-bar-chart-fill me-2"></i> Solar Panel Usage (%)</h5>
            <canvas id="solarChart" aria-label="Solar panel usage pie chart" role="img"></canvas>
          </div>
        </div>
        <div class="col-lg-4 col-md-6">
          <div class="card p-3 shadow-sm">
            <h5><i class="bi bi-droplet-half me-2"></i> Water Purification Volume (Liters)</h5>
            <canvas id="waterChart" aria-label="Water purification bar chart" role="img"></canvas>
          </div>
        </div>
        <div class="col-lg-4 col-md-12">
          <div class="card p-3 shadow-sm">
            <h5><i class="bi bi-clock-history me-2"></i> Alerts Over Time</h5>
            <canvas id="alertsChart" aria-label="Alerts line chart" role="img"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- CRUD Manage Units Page -->
    <section id="crud" class="d-none" role="region" aria-label="Manage Purification Units">
      <h2>Manage Purification Units</h2>
      <p>Add, update, or remove purification units in your system. Data is saved locally in your browser.</p>

      <form id="unitForm" class="row g-3 align-items-center mb-4" novalidate>
        <div class="col-sm-5">
          <label for="unitName" class="form-label">Unit Name</label>
          <input type="text" id="unitName" class="form-control" placeholder="Enter unit name" required aria-required="true" />
          <div class="invalid-feedback">Please enter the unit name.</div>
        </div>
        <div class="col-sm-4">
          <label for="unitStatus" class="form-label">Status</label>
          <select id="unitStatus" class="form-select" required aria-required="true">
            <option value="" selected disabled>Select status</option>
            <option value="Active">Active</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Inactive">Inactive</option>
          </select>
          <div class="invalid-feedback">Please select the status.</div>
        </div>
        <div class="col-sm-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100"><i class="bi bi-plus-circle me-2"></i>Add Unit</button>
        </div>
      </form>

      <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover align-middle" id="unitsTable" aria-describedby="unitsTableDesc">
          <caption id="unitsTableDesc">List of purification units with edit and delete options.</caption>
          <thead class="table-primary">
            <tr>
              <th scope="col">Unit Name</th>
              <th scope="col">Status</th>
              <th scope="col" class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Items inserted dynamically -->
          </tbody>
        </table>
      </div>
    </section>

  </main>
</div>

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel"><i class="bi bi-person-circle me-2"></i>User Login</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close login modal"></button>
      </div>
      <form id="loginForm" novalidate>
        <div class="modal-body">
          <div class="mb-3">
            <label for="loginUsername" class="form-label">Username</label>
            <input type="text" class="form-control" id="loginUsername" name="username" required aria-required="true" autocomplete="username" />
            <div class="invalid-feedback">Please enter your username.</div>
          </div>
          <div class="mb-3">
            <label for="loginPassword" class="form-label">Password</label>
            <input type="password" class="form-control" id="loginPassword" name="password" required aria-required="true" autocomplete="current-password" />
            <div class="invalid-feedback">Please enter your password.</div>
          </div>
        </div>
        <div class="modal-footer px-3">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Cancel login">Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-box-arrow-in-right me-1"></i>Login</button>
        </div>
      </form>
    </div>
  </div>
</div>

<footer class="footer" role="contentinfo" aria-label="Footer">
  <small>Â© 2025 Developed by Getrude Chizana, Harare Institute Of Technology - All rights reserved.</small>
</footer>

<!-- Bootstrap Bundle JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
(() => {
  "use strict";

  const USERNAME = "user";
  const PASSWORD = "user";

  const sidebar = document.getElementById('sidebar');
  const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');

  const navLinks = [...sidebar.querySelectorAll('nav.nav-link')];
  const logoutNav = document.getElementById('logoutNav');

  // Define all possible sections (IDs)
  const pages = [
    "welcome",
    "introduction",
    "objectives",
    "functionality",
    "requirements",
    "dashboard",
    "crud"
  ];

  // Map for quick element access
  const pageSections = pages.reduce((acc, id) => {
    acc[id] = document.getElementById(id);
    return acc;
  }, {});

  // Login modal and form
  const loginModalEl = document.getElementById('loginModal');
  const loginModal = new bootstrap.Modal(loginModalEl);
  const loginForm = document.getElementById('loginForm');
  const btnGoLogin = document.getElementById('btnGoLogin');

  // Dashboard stats elements
  const solarActiveCount = document.getElementById('solarActiveCount');
  const waterLitersCount = document.getElementById('waterLitersCount');
  const alertsCount = document.getElementById('alertsCount');

  // Charts variables
  let solarChart, waterChart, alertsChart;

  // CRUD elements
  const unitForm = document.getElementById('unitForm');
  const unitNameInput = document.getElementById('unitName');
  const unitStatusSelect = document.getElementById('unitStatus');
  const unitsTableBody = document.querySelector('#unitsTable tbody');

  // LocalStorage keys
  const KEY_UNITS = 'smartsolar_units';
  const KEY_CHARTDATA = 'smartsolar_chartdata';

  // State
  let loggedIn = false;

  // Initial setup: sidebar hidden, logout hidden, toggle hidden
  sidebar.classList.add('hidden');
  logoutNav.style.display = 'none';
  sidebarToggleBtn.style.display = 'none';

  // Alert credentials once per page load
  window.addEventListener('load', () => {
    setTimeout(() => alert(`Login credentials:\nUsername: ${USERNAME}\nPassword: ${PASSWORD}`), 400);
  });

  // Sidebar toggle button only active after login
  sidebarToggleBtn.addEventListener('click', () => {
    if (!loggedIn) return;
    const isOpen = sidebar.classList.toggle('open');
    sidebarToggleBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    if (isOpen) sidebar.focus();
  });

  // Navigation handling
  navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();

      // Logout first to ensure immediate action
      if (link.id === 'logoutNav') {
        if (confirm('Are you sure you want to logout?')) {
          logout();
        }
        return;
      }

      const target = link.getAttribute('data-section');

      // Block dashboard and crud until login
      if ((target === 'dashboard' || target === 'crud') && !loggedIn) {
        alert('Please login first to access this section.');
        showLogin();
        return;
      }

      switchPage(target);

      // Close sidebar on small screens after navigation
      if (window.innerWidth <= 992) {
        sidebar.classList.remove('open');
        sidebarToggleBtn.setAttribute('aria-expanded', 'false');
      }
    });
  });

  // Switch visible page content and manage active sidebar link
  function switchPage(id) {
    pages.forEach(pageId => {
      if (pageId === id) pageSections[pageId].classList.remove('d-none');
      else pageSections[pageId].classList.add('d-none');
    });

    navLinks.forEach(link => {
      const s = link.getAttribute('data-section');
      link.classList.toggle('active', s === id);
    });

    // Set focus for accessibility
    pageSections[id].focus();

    if (id === 'dashboard') updateDashboard();
    if (id === 'crud') renderUnits();
  }

  // Show login modal
  function showLogin() {
    loginModal.show();
    loginForm.reset();
    cleanValidation(loginForm);
  }

  btnGoLogin.addEventListener('click', () => {
    showLogin();
  });

  // Form validation helper
  function validateForm(form) {
    let valid = true;
    [...form.elements].forEach(el => {
      if (el.willValidate && !el.checkValidity()) {
        el.classList.add('is-invalid');
        valid = false;
      } else {
        el.classList.remove('is-invalid');
      }
    });
    return valid;
  }

  // Clear validation styles
  function cleanValidation(form) {
    [...form.elements].forEach(el => el.classList.remove('is-invalid'));
  }

  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!validateForm(loginForm)) return;

    const u = loginForm.username.value.trim();
    const p = loginForm.password.value;

    if (u === USERNAME && p === PASSWORD) {
      loginModal.hide();
      loginSuccess(u);
    } else {
      alert('Invalid username or password!');
    }
  });

  loginForm.username.addEventListener('input', () => loginForm.username.classList.remove('is-invalid'));
  loginForm.password.addEventListener('input', () => loginForm.password.classList.remove('is-invalid'));

  function loginSuccess(username) {
    loggedIn = true;
    sidebar.classList.remove('hidden');
    logoutNav.style.display = 'block';
    sidebarToggleBtn.style.display = 'block';
    // Directly go to dashboard without alert
    switchPage('dashboard');
  }

  function logout() {
    loggedIn = false;
    sidebar.classList.add('hidden');
    logoutNav.style.display = 'none';
    sidebarToggleBtn.style.display = 'none';
    switchPage('welcome');
    clearUnitsInputs();
    unitsTableBody.innerHTML = '';
  }

  // -------- CRUD for Units ---------
  function getUnits() {
    try {
      return JSON.parse(localStorage.getItem(KEY_UNITS)) || [];
    } catch {
      return [];
    }
  }
  function saveUnits(units) {
    localStorage.setItem(KEY_UNITS, JSON.stringify(units));
  }
  function clearUnitsInputs() {
    unitNameInput.value = '';
    unitStatusSelect.value = '';
    unitNameInput.classList.remove('is-invalid');
    unitStatusSelect.classList.remove('is-invalid');
  }

  function renderUnits() {
    const units = getUnits();
    unitsTableBody.innerHTML = '';
    if (units.length === 0) {
      unitsTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No units available.</td></tr>';
      updateDashboard();
      return;
    }

    units.forEach(u => {
      const tr = document.createElement('tr');
      tr.dataset.id = u.id;
      tr.innerHTML = `
        <td>${escapeHtml(u.name)}</td>
        <td>${escapeHtml(u.status)}</td>
        <td class="text-center">
          <button class="btn btn-sm btn-warning me-2" aria-label="Edit unit ${escapeHtml(u.name)}"><i class="bi bi-pencil-square"></i></button>
          <button class="btn btn-sm btn-danger" aria-label="Delete unit ${escapeHtml(u.name)}"><i class="bi bi-trash-fill"></i></button>
        </td>
      `;

      tr.querySelector('.btn-warning').addEventListener('click', () => editUnit(u.id));
      tr.querySelector('.btn-danger').addEventListener('click', () => {
        if (confirm(`Delete unit "${u.name}"? This cannot be undone.`)) {
          deleteUnit(u.id);
        }
      });

      unitsTableBody.appendChild(tr);
    });
    updateDashboard();
  }

  // Escape helper
  function escapeHtml(text) {
    const temp = document.createElement('div');
    temp.textContent = text;
    return temp.innerHTML;
  }

  // Add or Update Unit
  let currentEditId = null;
  unitForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!validateForm(unitForm)) return;

    let units = getUnits();
    const name = unitNameInput.value.trim();
    const status = unitStatusSelect.value;

    if (currentEditId) {
      const idx = units.findIndex(u => u.id === currentEditId);
      if (idx >= 0) {
        units[idx].name = name;
        units[idx].status = status;
        saveUnits(units);
        currentEditId = null;
        unitForm.querySelector('button[type="submit"]').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Add Unit';
      }
    } else {
      units.push({ id: crypto.randomUUID(), name, status });
      saveUnits(units);
    }

    clearUnitsInputs();
    renderUnits();
  });

  function editUnit(id) {
    const units = getUnits();
    const unit = units.find(u => u.id === id);
    if (!unit) return;

    unitNameInput.value = unit.name;
    unitStatusSelect.value = unit.status;
    currentEditId = id;
    unitForm.querySelector('button[type="submit"]').innerHTML = '<i class="bi bi-check-lg me-2"></i>Update Unit';
    unitNameInput.focus();
  }

  function deleteUnit(id) {
    let units = getUnits();
    units = units.filter(u => u.id !== id);
    saveUnits(units);
    if (currentEditId === id) {
      currentEditId = null;
      clearUnitsInputs();
      unitForm.querySelector('button[type="submit"]').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Add Unit';
    }
    renderUnits();
  }

  // -------- Charts & Dashboard --------
  function getChartData() {
    try {
      return JSON.parse(localStorage.getItem(KEY_CHARTDATA));
    } catch {
      return null;
    }
  }
  function saveChartData(data) {
    localStorage.setItem(KEY_CHARTDATA, JSON.stringify(data));
  }
  function generateSampleChartData() {
    const data = {
      waterLiters: [1200, 1500, 1800, 1700, 2100, 2300, 2500],
      alertsOverTime: [3, 2, 1, 4, 0, 1, 2],
      labels: generateLast7DaysLabels()
    };
    saveChartData(data);
    return data;
  }
  function generateLast7DaysLabels() {
    const labels = [];
    const today = new Date();
    for(let i = 6; i >= 0; i--) {
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      labels.push(d.toISOString().split("T")[0]);
    }
    return labels;
  }

  function updateDashboard() {
    const units = getUnits();
    const activeUnits = units.filter(u => u.status === 'Active').length;
    solarActiveCount.textContent = activeUnits;

    const totalWaterLiters = Math.min(activeUnits * 1200 + 500, 10000);
    waterLitersCount.textContent = totalWaterLiters;

    const alerts = units.filter(u => u.status === 'Maintenance').length;
    alertsCount.textContent = alerts;

    const data = getChartData() || generateSampleChartData();

    // Solar usage doughnut chart (Active vs inactive)
    if (solarChart) solarChart.destroy();
    const solarCtx = document.getElementById('solarChart').getContext('2d');
    solarChart = new Chart(solarCtx, {
      type: 'doughnut',
      data: {
        labels: ['Active', 'Inactive'],
        datasets: [{
          data: [activeUnits, Math.max(0, units.length - activeUnits)],
          backgroundColor: ['#0dcaf0', '#6c757d'],
          hoverOffset: 25,
          borderWidth: 1,
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom', labels: { color: '#212529', font: { weight: '600' } } },
          tooltip: { enabled: true }
        }
      }
    });

    // Water purification bar chart
    if (waterChart) waterChart.destroy();
    const waterCtx = document.getElementById('waterChart').getContext('2d');
    waterChart = new Chart(waterCtx, {
      type: 'bar',
      data: {
        labels: data.labels,
        datasets: [{
          label: 'Liters Purified',
          data: data.waterLiters,
          backgroundColor: '#198754',
          borderRadius: 6,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true },
          x: { grid: { display: false } }
        },
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        }
      }
    });

    // Alerts over time line chart
    if (alertsChart) alertsChart.destroy();
    const alertsCtx = document.getElementById('alertsChart').getContext('2d');
    alertsChart = new Chart(alertsCtx, {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [{
          label: 'Alerts',
          data: data.alertsOverTime,
          borderColor: '#ffc107',
          backgroundColor: 'rgba(255,193,7,0.3)',
          fill: true,
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 } },
          x: { grid: { display: false } }
        },
        plugins: {
          legend: { labels: { color: '#212529' } },
          tooltip: { enabled: true }
        }
      }
    });
  }

  // Initial page is Welcome and sidebar hidden
  switchPage('welcome');
})();
</script>
</body>
</html>
